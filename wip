#!/bin/bash

set -e

if [ -z "$1" ]
then
    echo "Usage: $(basename "$0") [amend commit push rebase rebase-onto reset]"
    exit 85
fi

function confirm {
    read -r -p "$0: continue? " response
    [[ "$response" =~ ^[yY] ]]
}

function do_amend {
    local status
    status="$(git status --porcelain --untracked-files=no 2> /dev/null)"
    if [ -n "${status}" ]
    then
        git commit --all --amend --no-edit
    fi
}

function do_commit {
    git commit --all -m 'WIP'
}

function do_push {
    git push --set-upstream origin "+$(git rev-parse --abbrev-ref HEAD)"
}

function do_rebase {
    git fetch --quiet
    git rebase --quiet origin/master
}

function do_rebase_onto() {
    base_branch="$1"
    current_branch="$(git rev-parse --abbrev-ref HEAD)"

    git checkout --quiet "$base_branch"
    base_rev="$(git rev-parse HEAD)"
    do_rebase

    git checkout --quiet "$current_branch"
    git rebase --quiet --onto "$base_branch" "$base_rev" "$current_branch"
}

function do_reset {
    git fetch
    git reset --hard "origin/$(git rev-parse --abbrev-ref HEAD)"
}

case "$1" in
amend)
    do_amend
    ;;
commit|wip)
    do_commit
    ;;
push)
    do_push
    ;;
rebase)
    do_rebase
    ;;
rebase-onto)
    do_rebase_onto "$2"
    ;;
reset)
    confirm && do_reset
    ;;
*)
    echo "Unknown command '$1'"
    exit 1
    ;;
esac
